<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qyrix AI - Ollama Voice Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&family=Inter&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(120deg, #05070f, #020409);
  color: white;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

.container {
  width: 100%;
  max-width: 600px;
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 20px;
  position: relative;
}

/* ROBOT CHARACTER */
.robot-container {
  width: 300px;
  height: 300px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 40px;
  position: relative;
}

.robot {
  width: 250px;
  height: 250px;
  position: relative;
  animation: float 3s ease-in-out infinite;
}

.robot-body {
  width: 200px;
  height: 200px;
  background: linear-gradient(135deg, #00f2ff, #0053b3);
  border-radius: 50%;
  position: relative;
  box-shadow: 0 0 50px rgba(0, 242, 255, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.robot-face {
  width: 100%;
  height: 100%;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Eyes */
.eye {
  position: absolute;
  width: 25px;
  height: 25px;
  background: white;
  border-radius: 50%;
  top: 70px;
  animation: blink 4s infinite;
  box-shadow: 0 0 10px rgba(255,255,255,0.8);
}

.eye.left { left: 60px; }
.eye.right { right: 60px; }

.eye::after {
  content: '';
  position: absolute;
  width: 12px;
  height: 12px;
  background: #0053b3;
  border-radius: 50%;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

/* Mouth */
.mouth {
  position: absolute;
  width: 60px;
  height: 30px;
  border: 4px solid white;
  border-top: none;
  border-radius: 0 0 60px 60px;
  bottom: 50px;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0;
  transition: opacity 0.2s;
}

.robot.talking .mouth {
  opacity: 1;
  animation: talk 0.5s ease-in-out infinite;
}

.robot.listening {
  animation: pulse 1s ease-in-out infinite;
}

.robot.listening .robot-body {
  box-shadow: 0 0 60px rgba(255, 0, 0, 1);
}

/* Status Text */
.status {
  font-size: 18px;
  color: #00f2ff;
  margin-bottom: 30px;
  text-align: center;
  min-height: 30px;
  font-family: 'Orbitron', sans-serif;
}

.status.listening {
  color: #ff6b6b;
  animation: pulse-text 1s ease-in-out infinite;
}

.status.error {
  color: #ff6b6b;
  font-size: 14px;
}

/* Voice Button */
.voice-btn {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(135deg, #00f2ff, #0053b3);
  box-shadow: 0 0 30px rgba(0, 242, 255, 0.8);
  color: white;
  font-size: 40px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
  position: relative;
}

.voice-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 0 40px rgba(0, 242, 255, 1);
}

.voice-btn.listening {
  background: linear-gradient(135deg, #ff6b6b, #c92a2a);
  box-shadow: 0 0 40px rgba(255, 107, 107, 1);
  animation: pulse-btn 1s ease-in-out infinite;
}

.voice-btn:active {
  transform: scale(0.95);
}

/* ANIMATIONS */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-15px); }
}

@keyframes blink {
  0%, 90%, 100% { transform: scaleY(1); }
  95% { transform: scaleY(0.1); }
}

@keyframes talk {
  0%, 100% { height: 30px; width: 60px; }
  50% { height: 45px; width: 70px; }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.15); }
}

@keyframes pulse-text {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

@keyframes pulse-btn {
  0%, 100% { box-shadow: 0 0 40px rgba(255, 107, 107, 1); }
  50% { box-shadow: 0 0 60px rgba(255, 107, 107, 1.5); }
}

/* Small text display */
.text-display {
  position: absolute;
  bottom: 150px;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 500px;
  background: rgba(0, 0, 0, 0.6);
  padding: 15px 20px;
  border-radius: 15px;
  border: 1px solid rgba(0, 242, 255, 0.3);
  font-size: 14px;
  text-align: center;
  min-height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(10px);
  opacity: 0;
  transition: opacity 0.3s;
  white-space: pre-line;
}

.text-display.show {
  opacity: 1;
}

.text-display {
  flex-wrap: wrap;
  gap: 10px;
}

.play-voice-btn {
  margin-top: 8px;
  padding: 8px 16px;
  border: 1px solid rgba(0, 242, 255, 0.6);
  background: rgba(0, 242, 255, 0.2);
  color: #00f2ff;
  border-radius: 20px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
}
.play-voice-btn:hover {
  background: rgba(0, 242, 255, 0.4);
  transform: scale(1.05);
}

/* Ollama Badge */
.ollama-badge {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(0, 242, 255, 0.2);
  padding: 8px 15px;
  border-radius: 20px;
  font-size: 12px;
  border: 1px solid rgba(0, 242, 255, 0.5);
}

/* Flow diagram */
.flow-diagram {
  position: absolute;
  top: 20px;
  left: 20px;
  font-size: 11px;
  color: rgba(0, 242, 255, 0.8);
  line-height: 1.6;
  font-family: 'Orbitron', sans-serif;
}
.flow-diagram span { display: block; }
.flow-diagram .arrow { color: rgba(0, 242, 255, 0.5); margin-left: 8px; }

/* Anime Girl character */
.robot-body {
  width: 160px;
  height: 220px;
  background: linear-gradient(180deg, #ffd4e5 0%, #ffb3d0 50%, #ff9ec4 100%);
  border-radius: 50% 50% 45% 45%;
  box-shadow: 0 0 40px rgba(255, 182, 193, 0.6), inset -5px -5px 15px rgba(255,255,255,0.5);
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow: visible;
  border: 3px solid rgba(255,255,255,0.8);
}

.robot-face {
  width: 140px;
  height: 140px;
  background: linear-gradient(160deg, #ffe4ec, #ffc9d9);
  border-radius: 50%;
  position: relative;
  box-shadow: inset 0 0 30px rgba(255,255,255,0.6), 0 4px 20px rgba(0,0,0,0.1);
  margin-top: -20px;
  border: 2px solid rgba(255,255,255,0.7);
}

/* Anime eyes */
.eye {
  position: absolute;
  width: 28px;
  height: 32px;
  background: white;
  border-radius: 50%;
  top: 42px;
  animation: blink 4s infinite;
  box-shadow: inset 0 -8px 0 #333, 0 0 8px rgba(0,0,0,0.1);
  border: 2px solid #e0c0c8;
}
.eye.left { left: 28px; }
.eye.right { right: 28px; }
.eye::after {
  content: '';
  position: absolute;
  width: 14px;
  height: 14px;
  background: #1a1a2e;
  border-radius: 50%;
  bottom: 6px;
  left: 50%;
  transform: translateX(-50%);
}

/* Lip sync mouth */
.mouth {
  position: absolute;
  width: 24px;
  height: 8px;
  background: #e85a7a;
  border-radius: 0 0 12px 12px;
  bottom: 38px;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0.9;
  transition: height 0.08s ease-out, border-radius 0.08s ease-out;
}
.robot.talking .mouth,
.mouth.lip-sync-open {
  height: 14px;
  border-radius: 0 0 12px 12px;
  animation: lip-sync 0.15s ease-in-out infinite;
}
@keyframes lip-sync {
  0%, 100% { height: 8px; }
  50% { height: 14px; }
}

.robot.listening .robot-body {
  box-shadow: 0 0 50px rgba(255, 100, 150, 0.8);
}
</style>
</head>
<body>

<div class="container">
  <div class="ollama-badge">ðŸ†“ Ollama (100% Free)</div>
  <div class="flow-diagram">
    <span>You speak ðŸŽ¤</span>
    <span class="arrow">â†“ Speech-to-Text</span>
    <span class="arrow">â†“ AI Brain (LLM)</span>
    <span class="arrow">â†“ Text-to-Speech</span>
    <span class="arrow">â†“ Audio + Lip Sync</span>
    <span>Live character talks ðŸ‘„âœ¨</span>
  </div>
  
  <!-- Anime Girl Character (Lip Sync) -->
  <div class="robot-container">
    <div class="robot" id="robot">
      <div class="robot-body">
        <div class="robot-face">
          <div class="eye left"></div>
          <div class="eye right"></div>
          <div class="mouth"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Text -->
  <div class="status" id="status">Click mic to start talking</div>

  <!-- Text Display (for showing what's being said) -->
  <div class="text-display" id="textDisplay"></div>

  <!-- Voice Button -->
  <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">
    ðŸŽ¤
  </button>
</div>

<script>
const robot = document.getElementById("robot");
const voiceBtn = document.getElementById("voiceBtn");
const status = document.getElementById("status");
const textDisplay = document.getElementById("textDisplay");
const BACKEND_URL = "http://127.0.0.1:8001"; // Different port for Ollama

// Check if browser supports speech recognition
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;
let isListening = false;
let synth = window.speechSynthesis;
let isSpeaking = false;
let lastBotReply = '';

// Initialize speech synthesis
let voiceEnabled = true;
if (!('speechSynthesis' in window)) {
  console.warn('Speech synthesis not supported');
  voiceEnabled = false;
  status.textContent = 'Voice not supported in this browser';
} else {
  function loadVoices() {
    const voices = synth.getVoices();
    console.log('Available voices:', voices.length);
  }
  if (synth.onvoiceschanged !== undefined) {
    synth.onvoiceschanged = loadVoices;
  }
  loadVoices();
  setTimeout(loadVoices, 1000);
}

// Initialize speech recognition if available
if (SpeechRecognition) {
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = 'en-US'; // English - better support in browsers

  recognition.onstart = () => {
    isListening = true;
    voiceBtn.classList.add('listening');
    robot.classList.add('listening');
    status.textContent = 'Listening... Speak now!';
    status.classList.add('listening');
    voiceBtn.textContent = 'ðŸ”´';
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    // STEP 1: Voice â†’ Text
    status.textContent = 'Voice â†’ Text âœ“';
    showText(transcript, 'user');
    setTimeout(() => {
      sendMessage(transcript);
    }, 400);
  };

  recognition.onerror = (event) => {
    console.error('Speech recognition error:', event.error);
    stopListening();
    status.textContent = 'Error: ' + event.error + '. Try again.';
    setTimeout(() => {
      status.textContent = 'Click mic to start talking';
    }, 3000);
  };

  recognition.onend = () => {
    stopListening();
  };
} else {
  voiceBtn.style.display = 'none';
  status.textContent = 'Voice recognition not supported. Please use Chrome or Edge.';
  console.warn('Speech recognition not supported in this browser');
}

function toggleVoice() {
  if (!recognition) {
    alert('Voice recognition is not supported in your browser. Please use Chrome or Edge.');
    return;
  }

  if (isListening) {
    recognition.stop();
  } else {
    if (isSpeaking) {
      synth.cancel();
      isSpeaking = false;
    }
    recognition.start();
  }
}

function stopListening() {
  isListening = false;
  voiceBtn.classList.remove('listening');
  robot.classList.remove('listening');
  status.classList.remove('listening');
  voiceBtn.textContent = 'ðŸŽ¤';
  if (!isSpeaking) {
    status.textContent = 'Click mic to start talking';
  }
}

function detectLanguage(text) {
  const urduRegex = /[\u0600-\u06FF]/;
  const hindiRegex = /[\u0900-\u097F]/;
  const arabicRegex = /[\u0600-\u06FF\u0750-\u077F]/;
  const spanishRegex = /[Ã¡Ã©Ã­Ã³ÃºÃ±Ã¼ÃÃ‰ÃÃ“ÃšÃ‘Ãœ]/;
  const frenchRegex = /[Ã Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Ã§Ã€Ã‚Ã„Ã‰ÃˆÃŠÃ‹ÃÃŽÃ”Ã™Ã›ÃœÅ¸Ã‡]/;
  
  if (urduRegex.test(text) || arabicRegex.test(text)) return 'ur-PK';
  if (hindiRegex.test(text)) return 'hi-IN';
  if (spanishRegex.test(text)) return 'es-ES';
  if (frenchRegex.test(text)) return 'fr-FR';
  return 'en-US';
}

function findBestVoice(langCode) {
  const voices = synth.getVoices();
  if (!voices || voices.length === 0) return null;
  
  if (langCode === 'ur-PK') {
    let voice = voices.find(v => v.lang === 'ur-PK' || v.lang === 'ur');
    if (voice) return voice;
    const arabicVoices = voices.filter(v => 
      v.lang.startsWith('ar-') || 
      v.lang === 'ar' ||
      v.name.toLowerCase().includes('arabic') ||
      v.name.toLowerCase().includes('urdu')
    );
    if (arabicVoices.length > 0) return arabicVoices[0];
  }
  
  let voice = voices.find(v => v.lang === langCode);
  if (voice) return voice;
  
  const langPrefix = langCode.split('-')[0];
  voice = voices.find(v => v.lang.startsWith(langPrefix));
  if (voice) return voice;
  
  return voices.find(v => v.default) || voices[0];
}

function showText(text, type) {
  textDisplay.innerHTML = '';
  const span = document.createElement('span');
  span.style.flex = '1 1 100%';
  span.textContent = text;
  textDisplay.appendChild(span);
  if (type === 'bot') {
    lastBotReply = text;
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'play-voice-btn';
    btn.textContent = 'ðŸ”Š Play';
    btn.onclick = () => speakText(lastBotReply);
    textDisplay.appendChild(btn);
  }
  textDisplay.classList.add('show');
  setTimeout(() => {
    textDisplay.classList.remove('show');
  }, 8000);
}

function speakText(text) {
  if (!text || text.trim() === '') return;
  
  try {
    synth.cancel();
    isSpeaking = true;
    status.textContent = 'Qyrix is speaking (Text â†’ Voice)';
    robot.classList.add('talking');
    showText(text, 'bot');
    
    if (synth.resume) synth.resume();
    
    const utterance = new SpeechSynthesisUtterance(text);
    const detectedLang = detectLanguage(text);
    
    if (detectedLang === 'ur-PK') {
      const bestVoice = findBestVoice('ur-PK');
      if (bestVoice) {
        utterance.voice = bestVoice;
        utterance.lang = bestVoice.lang.startsWith('ar') ? bestVoice.lang : 'ur-PK';
      } else {
        utterance.lang = 'en-US';
      }
    } else if (detectedLang === 'hi-IN') {
      const bestVoice = findBestVoice('hi-IN');
      if (bestVoice) {
        utterance.voice = bestVoice;
        utterance.lang = bestVoice.lang;
      } else {
        utterance.lang = 'en-US';
      }
    } else {
      utterance.lang = detectedLang;
      const bestVoice = findBestVoice(detectedLang);
      if (bestVoice) utterance.voice = bestVoice;
    }
    
    utterance.rate = 0.9;
    utterance.pitch = 1.1;
    utterance.volume = 1.0;

    utterance.onstart = () => {
      console.log('Speech started');
    };

    utterance.onend = () => {
      robot.classList.remove('talking');
      isSpeaking = false;
      status.textContent = 'Click mic to start talking';
      console.log('Speech ended');
      // GPT-style: AI bolne ke baad khud dubara sunne lagaao (voice-to-voice)
      try {
        setTimeout(() => {
          if (!isListening && recognition) {
            status.textContent = 'Speak now...';
            recognition.start();
          }
        }, 300);
      } catch (e) {}
    };

    utterance.onerror = (event) => {
      robot.classList.remove('talking');
      isSpeaking = false;
      status.textContent = 'Click mic to start talking';
      console.error('Speech error:', event);
    };

    if (synth.speaking) {
      synth.cancel();
      setTimeout(() => { synth.resume && synth.resume(); synth.speak(utterance); }, 150);
    } else {
      synth.speak(utterance);
    }
  } catch (error) {
    console.error('Error in speakText:', error);
    robot.classList.remove('talking');
    isSpeaking = false;
    status.textContent = 'Click mic to start talking';
  }
}

async function sendMessage(text) {
  status.textContent = 'Getting answer...';
  robot.classList.remove('listening');
  
  try {
    const res = await fetch(`${BACKEND_URL}/chat`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });
    
    const data = await res.json();
    
    if (data.reply && !data.reply.startsWith('âŒ') && !data.reply.startsWith('â³')) {
      lastBotReply = data.reply;
      status.textContent = 'Text â†’ Voice (speaking reply)';
      speakText(data.reply);
    } else {
      // Show error message
      status.textContent = data.reply || 'Error occurred';
      status.classList.add('error');
      showText(data.reply, 'error');
      setTimeout(() => {
        status.classList.remove('error');
        status.textContent = 'Click mic to start talking';
      }, 5000);
    }
    
  } catch (error) {
    console.error('Error:', error);
    const errorMsg = `Backend offline. Please:\n1. Make sure Ollama is running\n2. Start backend: python main_ollama.py\n3. Check port 8001`;
    status.textContent = 'Backend offline';
    status.classList.add('error');
    showText(errorMsg, 'error');
    setTimeout(() => {
      status.classList.remove('error');
      status.textContent = 'Click mic to start talking';
    }, 5000);
  }
}
</script>

</body>
</html>

